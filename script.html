<script>
// --- GLOBAL VARS FOR SCANNER ---
let currentPdfFile = null;
let currentPdfBlobUrl = null;

// Initialize Scanner when module loads
function initScannerModule() {
    // Auto-fill "Added By" from logged-in user
    const currentUser = localStorage.getItem('approvalName');
    if (currentUser) {
        document.getElementById('scan-added-by').value = currentUser;
    }
}

// Handle File Selection
function handleFileUpload(input) {
    if (input.files && input.files[0]) {
        currentPdfFile = input.files[0];
        document.getElementById('file-name-display').textContent = currentPdfFile.name;
        document.getElementById('file-name-display').style.color = 'green';
        
        // Enable button
        document.getElementById('btn-extract-analyze').disabled = false;

        // Create Blob for preview
        if (currentPdfBlobUrl) URL.revokeObjectURL(currentPdfBlobUrl);
        currentPdfBlobUrl = URL.createObjectURL(currentPdfFile);
    }
}

// Main AI Process Function
async function processWithAI() {
    // 1. Validation
    const date = document.getElementById('scan-invoice-date').value;
    const givenBy = document.getElementById('scan-given-by').value;
    
    if (!date || !givenBy) {
        alert("Please fill 'Invoice Date' and 'Bill Given By' before processing.");
        return;
    }

    // 2. UI Update
    const loader = document.getElementById('scanner-loader');
    const statusText = document.getElementById('scan-status-text');
    loader.style.display = 'block';
    document.getElementById('btn-extract-analyze').disabled = true;

    try {
        // 3. Extract Text (Client Side)
        statusText.innerText = "Extracting text from PDF...";
        const fileReader = new FileReader();
        
        fileReader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            try {
                // Use PDF.js
                const extractedText = await extractTextFromPdf(typedarray);
                
                if (!extractedText) throw new Error("Text extraction failed.");
                
                // 4. Send to Gemini (Apps Script)
                statusText.innerText = "Analyzing with AI...";
                
                // Construct Payload
                const payload = { 
                    action: "analyze", // Ensure this function exists in code.gs
                    text: extractedText 
                };

                // Use the existing SCRIPT_URL from biller.html
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                
                const result = await response.json();
                
                if (result.status === 'success' || result.success) {
                    // 5. Prepare Data for Verification
                    const uniqueId = `BID-${Date.now()}`;
                    const manualData = {
                        "Invoice Received Date": date,
                        "Bill Source": document.getElementById('scan-source').value,
                        "Bill Given By": givenBy,
                        "Added By": document.getElementById('scan-added-by').value,
                        "HOD Approval": document.getElementById('scan-hod').value,
                        "Final Approval": document.getElementById('scan-final').value,
                        'HOD Approval Status': 'Pending',
                        'Final Approval Status': 'Pending',
                        "Unique ID": uniqueId
                    };
                    
                    // Merge AI data with Manual Data
                    const finalDataObject = { ...manualData, ...result.data };
                    
                    // Open Popup
                    loader.style.display = 'none';
                    openVerificationPopup(finalDataObject);
                } else {
                    throw new Error(result.message || "AI Analysis failed");
                }

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                loader.style.display = 'none';
                document.getElementById('btn-extract-analyze').disabled = false;
            }
        };
        fileReader.readAsArrayBuffer(currentPdfFile);

    } catch (e) {
        alert("System Error: " + e.message);
        loader.style.display = 'none';
        document.getElementById('btn-extract-analyze').disabled = false;
    }
}

// PDF Extraction Logic (Same as before)
async function extractTextFromPdf(pdfData) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';
    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
    let combinedText = '';
    
    // Try Standard Extraction
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        if (textContent.items.length > 0) {
            combinedText += textContent.items.map(s => s.str).join(' ') + '\n';
        }
    }

    // Fallback to OCR if text is too short (Scanned Image)
    if (combinedText.length < 50) {
        document.getElementById('scan-status-text').innerText = "Running OCR (Image Scan)...";
        const worker = await Tesseract.createWorker('eng');
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
            const { data: { text } } = await worker.recognize(canvas);
            combinedText += text + '\n';
        }
        await worker.terminate();
    }
    return combinedText.trim();
}

// Verification Popup Logic
function openVerificationPopup(data) {
    const popup = window.open('', '_blank', 'width=1200,height=800');
    
    let formHtml = '';
    // Define the order of fields you want to show
    const fieldOrder = ['Vendor Name', 'InvoiceNumber', 'InvoiceDate', 'FinalAmountPayable', 'Unique ID'];
    
    // Create inputs
    for (const key in data) {
        const value = String(data[key] || '').replace(/"/g, '&quot;');
        const isReadOnly = (key === "Unique ID" || key.includes("Status"));
        const bgColor = isReadOnly ? '#f0f0f0' : '#fff';
        
        formHtml += `
        <div style="margin-bottom:10px;">
            <label style="font-weight:bold; display:block; font-size:12px; color:#555;">${key}</label>
            <input type="text" id="edit-${key}" value="${value}" 
            ${isReadOnly ? 'readonly' : ''} 
            style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background:${bgColor};">
        </div>`;
    }

    popup.document.write(`
        <html>
        <head>
            <title>Verify Extracted Data</title>
            <style>
                body{ font-family: 'Segoe UI', sans-serif; padding:0; margin:0; display:flex; height:100vh; }
                .left-panel { width: 50%; height: 100%; border-right: 2px solid #ddd; }
                .right-panel { width: 50%; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; background: #f9f9f9; }
                h2 { margin-top: 0; color: #333; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
                .btn-save { background: #28a745; color: white; border: none; padding: 15px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 20px; }
                .btn-save:hover { background: #218838; }
            </style>
        </head>
        <body>
            <div class="left-panel">
                <embed src="${currentPdfBlobUrl}" width="100%" height="100%">
            </div>
            <div class="right-panel">
                <h2>Verify & Submit</h2>
                <div id="form-container">${formHtml}</div>
                <button id="confirm-btn" class="btn-save">CONFIRM & SAVE TO SHEET</button>
            </div>
            <script>
                document.getElementById('confirm-btn').onclick = () => {
                    const finalData = {};
                    document.querySelectorAll('input').forEach(input => {
                        const key = input.id.replace('edit-', '');
                        finalData[key] = input.value;
                    });
                    // Call function in Parent Window
                    window.opener.finalizeSubmission(finalData);
                    window.close();
                };
            <\/script>
        </body>
        </html>
    `);
}

// Final Save Function (Called by Popup)
async function finalizeSubmission(data) {
    const loader = document.getElementById('scanner-loader');
    const statusText = document.getElementById('scan-status-text');
    loader.style.display = 'block';
    statusText.innerText = "Uploading File & Saving Data...";

    try {
        // Convert File to Base64
        const reader = new FileReader();
        reader.readAsDataURL(currentPdfFile);
        reader.onload = async () => {
            const base64 = reader.result.split(',')[1];
            
            const payload = {
                action: 'save', // Ensure this exists in code.gs
                data: data,
                fileBase64: base64,
                fileName: currentPdfFile.name
            };

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success' || result.success) {
                alert("Success! Entry Saved.");
                
                // RESET SCANNER
                document.getElementById('scanner-pdf-upload').value = '';
                document.getElementById('file-name-display').textContent = 'No file selected';
                document.getElementById('scan-invoice-date').value = '';
                document.getElementById('scan-given-by').value = '';
                
                // RETURN TO PENDING TABLE
                showSection('pending');
                fetchAndRenderData(); // Refresh Data
            } else {
                alert("Error Saving: " + result.message);
            }
            loader.style.display = 'none';
        };
    } catch (e) {
        alert("Submission Error: " + e.message);
        loader.style.display = 'none';
    }
}
</script>
